<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Drawn Dog Competition</title>
    <style>
        :root {
            /* Brand Colors: Warm, Earthy yet Premium */
            --c-cream: #FDFBF7;
            --c-surface: #FFFFFF;
            --c-surface-alt: #F3F4F6;
            
            --c-primary: #D97706; /* Warm Amber */
            --c-primary-hover: #B45309;
            --c-secondary: #78350F; /* Deep Brown */
            
            --c-text-main: #1F2937;
            --c-text-muted: #6B7280;
            
            --c-accent-teal: #14B8A6;
            --c-accent-rose: #F43F5E;

            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-pill: 9999px;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --c-cream: #111827;
                --c-surface: #1F2937;
                --c-surface-alt: #374151;
                --c-text-main: #F9FAFB;
                --c-text-muted: #9CA3AF;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--c-cream);
            color: var(--c-text-main);
            line-height: 1.5;
            padding-bottom: 40px;
        }

        /* --- HERO SECTION --- */
        .hero {
            background: linear-gradient(135deg, var(--c-surface) 0%, var(--c-surface-alt) 100%);
            padding: 60px 20px 40px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 800;
            color: var(--c-secondary);
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--c-text-muted);
            max-width: 600px;
            margin: 0 auto 32px;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 32px;
            font-size: 0.9rem;
            color: var(--c-text-muted);
        }

        .hero-stats strong { color: var(--c-primary); }

        .btn-cta {
            background: var(--c-primary);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 16px 48px;
            border-radius: var(--radius-pill);
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-cta:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: var(--c-primary-hover);
        }

        /* --- STICKY NAV --- */
        .nav-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 10px 20px;
            margin-bottom: 40px;
        }
        
        @media (prefers-color-scheme: dark) {
            .nav-container { background: rgba(31, 41, 55, 0.9); }
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            max-width: 800px;
            margin: 0 auto;
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: var(--radius-pill);
            border: none;
            background: transparent;
            color: var(--c-text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover { background: var(--c-surface-alt); color: var(--c-text-main); }
        .nav-tab.active { background: var(--c-text-main); color: var(--c-surface); }

        /* --- LAYOUT --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DRAWING INTERFACE --- */
        .drawing-card {
            background: var(--c-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            background: var(--c-surface-alt);
            padding: 12px;
            border-radius: var(--radius-md);
            width: 100%;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: var(--c-surface);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: grid;
            place-items: center;
        }

        .tool-btn.active { border-color: var(--c-primary); color: var(--c-primary); background: #FFF7ED; }
        .tool-btn:hover:not(.active) { background: #E5E7EB; }

        .canvas-wrapper {
    position: relative;
    box-shadow: var(--shadow-md);
    border-radius: 8px;
    overflow: hidden;
    border: 4px solid var(--c-text-main); /* Frame effect */
    margin: 20px auto;
    background: white;
    max-width: 600px;
    width: 100%;
        }

        /* --- GALLERY GRID --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .art-card {
            background: var(--c-surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .art-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .art-image {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: contain;
            background: white;
            border-bottom: 1px solid var(--c-surface-alt);
        }

        .art-info { padding: 16px; flex: 1; display: flex; flex-direction: column; }
        .art-title { font-weight: 700; margin-bottom: 4px; font-size: 1.1rem; }
        .art-meta { color: var(--c-text-muted); font-size: 0.9rem; margin-bottom: 12px; display: flex; justify-content: space-between; }
        
        .vote-btn {
            margin-top: auto;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .vote-btn.can-vote { background: var(--c-surface-alt); color: var(--c-text-main); }
        .vote-btn.can-vote:hover { background: var(--c-accent-rose); color: white; }
        
        .vote-btn.voted { background: var(--c-accent-teal); color: white; cursor: default; }
        .vote-btn.own-art { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 16px; width: 100%; max-width: 400px; text-align: left; }
        .input-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 1rem;
            background: var(--c-surface);
            color: var(--c-text-main);
        }
        .form-control:focus { outline: 2px solid var(--c-primary); border-color: transparent; }

        /* --- NOTIFICATIONS --- */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--c-text-main);
            color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--c-accent-teal); }
        .toast.error { border-left: 4px solid var(--c-accent-rose); }

        /* --- LEADERBOARD --- */
        .rank-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--c-surface-alt);
        }
        .rank-num { font-size: 1.5rem; font-weight: 800; width: 50px; text-align: center; color: var(--c-text-muted); }
        .rank-1 { color: #F59E0B; }
        .rank-2 { color: #9CA3AF; }
        .rank-3 { color: #B45309; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .canvas-wrapper canvas { width: 100%; height: auto; }
            .nav-tabs { overflow-x: auto; justify-content: flex-start; padding-bottom: 4px; }
            .nav-tab { white-space: nowrap; }
        }
    </style>
    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="hero">
        <h1>üêæ Hand Drawn Dog Competition</h1>
        <p>Show off your artistic skills. Draw a dog, get votes, and become the top artist.</p>
        
        <div class="hero-stats">
            <span><strong id="statTotalDrawings">0</strong> Drawings</span>
            <span>‚Ä¢</span>
            <span><strong id="statTotalVotes">0</strong> Votes Cast</span>
        </div>

        <button class="btn-cta" onclick="activateTab('draw')">‚úèÔ∏è Start Drawing Now</button>
    </header>

    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="activateTab('draw')">Draw</button>
            <button class="nav-tab" onclick="activateTab('gallery')">Gallery</button>
            <button class="nav-tab" onclick="activateTab('leaderboard')">Leaderboard</button>
            <button class="nav-tab" onclick="activateTab('accuracy')">Smart Score</button>
        </div>
    </nav>

    <div class="container">
        
        <div id="draw" class="tab-content active">
            <div class="input-group">
    <label class="input-label">1. Give Your Drawing a Title</label>
    <input type="text" id="dogTitle" class="form-control" placeholder="Your Dog Title" maxlength="50">
</div>

<div class="input-group">
    <label class="input-label">Choose a Reference (Optional)</label>
    <select id="refSelect" class="form-control">
        <option value="">Select a dog photo...</option>
    </select>
</div>

                <div class="toolbar">
                    <button class="tool-btn active" id="btnPen" title="Pen">üñäÔ∏è</button>
                    <button class="tool-btn" id="btnBrush" title="Brush">üñåÔ∏è</button>
                    <button class="tool-btn" id="btnEraser" title="Eraser">üßπ</button>
                    <button class="tool-btn" id="btnFill" title="Fill">ü™£</button>
                    <div style="width: 1px; background: #ddd; margin: 0 8px;"></div>
                    <input type="color" id="colorPicker" value="#000000" style="height: 44px; width: 44px; padding: 0; border: none; cursor: pointer;">
                    <div style="width: 1px; background: #ddd; margin: 0 8px;"></div>
                    <button class="tool-btn" id="btnUndo" title="Undo">‚Ü∂</button>
                    <button class="tool-btn" id="btnClear" title="Clear">üóëÔ∏è</button>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="refCanvas" width="600" height="450" style="position: absolute; pointer-events: none; opacity: 0;"></canvas>
                    <canvas id="overlayCanvas" width="600" height="450" style="position: absolute; pointer-events: none; top:0; left:0;"></canvas>
                    <canvas id="drawCanvas" width="600" height="450"></canvas>
                </div>

                <div class="input-group" style="display: flex; gap: 10px; align-items: flex-end; margin-top: 20px;">
                    <div style="flex: 1;">
                        <label class="input-label">2. Sign your Masterpiece</label>
                        <input type="text" id="artistName" class="form-control" placeholder="Your Artist Name" maxlength="30">
                    </div>
                    <button class="btn-cta" id="btnSubmit" style="padding: 10px 24px; font-size: 1rem;">Publish</button>
                </div>
                
                <div style="margin-top: 10px;">
                     <label style="font-size: 0.9rem; color: var(--c-text-muted);">
                        <input type="checkbox" id="toggleRef" disabled> Show Reference Overlay
                    </label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="30" disabled style="vertical-align: middle;">
                </div>
            </div>
        </div>

        <div id="gallery" class="tab-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h2>Latest Submissions</h2>
                <span style="font-size: 0.9rem; color: var(--c-text-muted);">Sorted by Popularity</span>
            </div>
            <div id="galleryGrid" class="gallery-grid">
                </div>
        </div>

        <div id="leaderboard" class="tab-content">
            <div class="drawing-card" style="align-items: stretch; max-width: 800px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 20px;">üèÜ Hall of Fame</h2>
                <div id="leaderboardList">
                    </div>
            </div>
        </div>

        <div id="accuracy" class="tab-content">
            <div class="drawing-card" style="align-items: stretch; max-width: 800px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 10px;">üéØ Smart Accuracy Scores</h2>
                <p style="text-align: center; color: var(--c-text-muted); margin-bottom: 30px;">
                    Our algorithm analyzes color matching and shape composition.
                </p>
                <div id="accuracyList">
                    </div>
            </div>
        </div>

    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- CONFIG & STATE ---
        const CONFIG = {
            width: 600,
            height: 450,
            dogs: [
                { name: 'Dawg w the glasses', url: 'https://images.unsplash.com/photo-1554224311-beee415c201f?q=80&w=735&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                { name: 'Banana dog', url: 'https://images.unsplash.com/photo-1701445175220-1f485a27fb41?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8ZnVubnklMjBkb2d8ZW58MHx8MHx8fDA%3D' },
                { name: 'Golden', url: 'https://images.unsplash.com/photo-1510771463146-e89e6e86560e?q=80&w=627&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                { name: 'Fluff', url: 'https://images.unsplash.com/photo-1505628346881-b72b27e84530?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                { name: 'Annoying shit that barks for no reason', url: 'https://images.unsplash.com/photo-1583511655826-05700d52f4d9?q=80&w=688&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                { name: 'Murica', url: 'https://images.unsplash.com/photo-1422565096762-bdb997a56a84?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
            ]
        };

        const STATE = {
            drawings: [],
            myVotes: new Set(),
            tool: 'pen',
            color: '#000000',
            isDrawing: false,
            history: [],
            historyStep: -1,
            refImage: null,
            lastPos: { x: 0, y: 0 }
        };

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const refCanvas = document.getElementById('refCanvas');
        const refCtx = refCanvas.getContext('2d', { willReadFrequently: true });
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayCtx = overlayCanvas.getContext('2d');

        // --- INITIALIZATION ---
        function init() {
            // Load LocalStorage
            const storedDrawings = localStorage.getItem('hddc_drawings');
            const storedVotes = localStorage.getItem('hddc_votes');
            
            if (storedDrawings) STATE.drawings = JSON.parse(storedDrawings);
            if (storedVotes) STATE.myVotes = new Set(JSON.parse(storedVotes));

            // Setup Canvas Defaults
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveHistory();

            // Populate Dropdown
            const select = document.getElementById('refSelect');
            CONFIG.dogs.forEach((dog, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = dog.name;
                select.appendChild(opt);
            });

            // Update Stats
            updateGlobalStats();
        }

        // --- DRAWING LOGIC ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            return { x: x * scaleX, y: y * scaleY };
        }

        function startDraw(e) {
            if(e.type !== 'mousedown' && e.type !== 'touchstart') return;
            e.preventDefault();
            STATE.isDrawing = true;
            STATE.lastPos = getPos(e);
            
            if(STATE.tool === 'fill') {
                floodFill(Math.floor(STATE.lastPos.x), Math.floor(STATE.lastPos.y), STATE.color);
                STATE.isDrawing = false;
                saveHistory();
            }
        }

        function moveDraw(e) {
            if(!STATE.isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);

            ctx.beginPath();
            ctx.moveTo(STATE.lastPos.x, STATE.lastPos.y);
            ctx.lineTo(pos.x, pos.y);
            
            ctx.strokeStyle = STATE.tool === 'eraser' ? '#FFFFFF' : STATE.color;
            ctx.lineWidth = STATE.tool === 'pen' ? 3 : STATE.tool === 'brush' ? 8 : 20; // Eraser size
            
            if(STATE.tool === 'eraser') {
                 // Simple white stroke for eraser to keep it compatible with simple fill/save
                 ctx.strokeStyle = '#FFFFFF';
            }

            ctx.stroke();
            STATE.lastPos = pos;
        }

        function endDraw() {
            if(STATE.isDrawing) {
                STATE.isDrawing = false;
                saveHistory();
            }
        }

        // --- FLOOD FILL ---
        function floodFill(x, y, hexColor) {
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imgData.data;
            const targetColor = getPixel(data, x, y);
            const fillColor = hexToRgb(hexColor);
            
            if(colorsMatch(targetColor, fillColor)) return;

            const stack = [[x, y]];
            while(stack.length) {
                const [cx, cy] = stack.pop();
                if(cx < 0 || cx >= canvas.width || cy < 0 || cy >= canvas.height) continue;
                
                const current = getPixel(data, cx, cy);
                if(colorsMatch(current, targetColor)) {
                    setPixel(data, cx, cy, fillColor);
                    stack.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }
        
        function getPixel(data, x, y) {
            const i = (y * canvas.width + x) * 4;
            return {r: data[i], g: data[i+1], b: data[i+2]};
        }
        
        function setPixel(data, x, y, c) {
            const i = (y * canvas.width + x) * 4;
            data[i] = c.r; data[i+1] = c.g; data[i+2] = c.b; data[i+3] = 255;
        }
        
        function colorsMatch(c1, c2) {
            // Tolerance of 10 for compression artifacts
            return Math.abs(c1.r - c2.r) < 10 && Math.abs(c1.g - c2.g) < 10 && Math.abs(c1.b - c2.b) < 10;
        }
        
        function hexToRgb(hex) {
            const r = parseInt(hex.substr(1,2), 16);
            const g = parseInt(hex.substr(3,2), 16);
            const b = parseInt(hex.substr(5,2), 16);
            return {r,g,b};
        }

        // --- HISTORY ---
        function saveHistory() {
            STATE.historyStep++;
            STATE.history = STATE.history.slice(0, STATE.historyStep);
            STATE.history.push(canvas.toDataURL());
            if(STATE.history.length > 10) { STATE.history.shift(); STATE.historyStep--; }
        }

        function undo() {
            if(STATE.historyStep > 0) {
                STATE.historyStep--;
                const img = new Image();
                img.src = STATE.history[STATE.historyStep];
                img.onload = () => {
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(img,0,0);
                }
            }
        }

        // --- REFERENCE IMAGE ---
        document.getElementById('refSelect').addEventListener('change', (e) => {
            if(!e.target.value) return;
            const url = CONFIG.dogs[e.target.value].url;
            
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = url;
            img.onload = () => {
                STATE.refImage = img;
                
                // Draw to hidden canvas for calculations (resized to fit)
                const scale = Math.min(canvas.width/img.width, canvas.height/img.height);
                const w = img.width * scale;
                const h = img.height * scale;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;
                
                refCtx.fillStyle = '#FFFFFF';
                refCtx.fillRect(0,0,canvas.width, canvas.height);
                refCtx.drawImage(img, x, y, w, h);
                
                // Update Overlay
                updateOverlay();
                
                // Enable Controls
                document.getElementById('toggleRef').disabled = false;
                document.getElementById('toggleRef').checked = true;
                document.getElementById('opacitySlider').disabled = false;
            };
        });

        function updateOverlay() {
            overlayCtx.clearRect(0,0,canvas.width, canvas.height);
            if(document.getElementById('toggleRef').checked && STATE.refImage) {
                const opacity = document.getElementById('opacitySlider').value / 100;
                overlayCtx.globalAlpha = opacity;
                overlayCtx.drawImage(refCanvas, 0, 0);
            }
        }

        // --- ACCURACY ALGO ---
        function calculateAccuracy() {
            if(!STATE.refImage) return { total: 0, color: 0, shape: 0 };

            const dData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
            const rData = refCtx.getImageData(0,0,canvas.width,canvas.height).data;
            
            let matchColor = 0, matchShape = 0, totalContent = 0;

            // Sample every 4th pixel for performance
            for(let i=0; i<dData.length; i+=16) {
                const rR=rData[i], rG=rData[i+1], rB=rData[i+2];
                const dR=dData[i], dG=dData[i+1], dB=dData[i+2];

                // Is reference NOT white (is it dog?)
                const isRefContent = (rR < 250 || rG < 250 || rB < 250);
                const isDrawContent = (dR < 250 || dG < 250 || dB < 250);

                if(isRefContent) {
                    totalContent++;
                    
                    if(isDrawContent) {
                        matchShape++;
                        // Color diff
                        const diff = Math.abs(rR-dR) + Math.abs(rG-dG) + Math.abs(rB-dB);
                        if(diff < 100) matchColor++;
                    }
                }
            }

            if(totalContent === 0) return { total: 0 };
            
            const shapeScore = (matchShape / totalContent) * 100;
            const colorScore = matchShape > 0 ? (matchColor / matchShape) * 100 : 0;
            const total = (shapeScore * 0.6) + (colorScore * 0.4);

            return {
                total: Math.round(total),
                shape: Math.round(shapeScore),
                color: Math.round(colorScore)
            };
        }

        // --- SUBMIT & VOTE ---
       
        function vote(id) {
            const drawing = STATE.drawings.find(d => d.id === id);
            
            // Checks
            if(!drawing) return;
            if(STATE.myVotes.has(id)) {
                showToast('You already voted for this!', 'error');
                return;
            }
            if(drawing.isLocal) {
                showToast('You cannot vote for your own art!', 'error');
                return;
            }

            // Execute Vote
            drawing.votes++;
            STATE.myVotes.add(id);
            saveData();
            
            // UI Update
            showToast('Vote cast! ‚ù§Ô∏è', 'success');
            renderGallery(); // Re-render to sort
            updateGlobalStats();
        }

        // --- RENDERING ---
        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            
            // SORTING LOGIC: Votes Descending, then Date Descending
            const sorted = [...STATE.drawings].sort((a, b) => {
                if (b.votes !== a.votes) return b.votes - a.votes;
                return b.timestamp - a.timestamp;
            });

            grid.innerHTML = sorted.map(d => {
                const isVoted = STATE.myVotes.has(d.id);
                const isOwn = d.isLocal === true;
                
                let btnClass = 'can-vote';
                let btnText = '‚ù§Ô∏è Vote';
                let btnAction = `onclick="vote(${d.id})"`;
                
                if (isOwn) {
                    btnClass = 'own-art';
                    btnText = 'üë§ Your Art';
                    btnAction = '';
                } else if (isVoted) {
                    btnClass = 'voted';
                    btnText = '‚úÖ Voted';
                    btnAction = '';
                }

                return `
                <div class="art-card">
                    <img src="${d.image}" class="art-image">
                    <div class="art-info">
                        <div class="art-title">${escapeHtml(d.artist)}</div>
                        <div class="art-meta">
                            <span>‚ù§Ô∏è ${d.votes}</span>
                            <span>Score: ${d.scores.total || 0}%</span>
                        </div>
                        <button class="vote-btn ${btnClass}" ${btnAction}>
                            ${btnText}
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const sorted = [...STATE.drawings].sort((a, b) => b.votes - a.votes).slice(0, 10);
            
            if(sorted.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">No drawings yet. Be the first!</div>';
                return;
            }

            list.innerHTML = sorted.map((d, i) => `
                <div class="rank-row">
                    <div class="rank-num rank-${i+1}">${i+1}</div>
                    <img src="${d.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border:1px solid #eee;">
                    <div style="margin-left: 15px; flex: 1;">
                        <div style="font-weight:700;">${escapeHtml(d.artist)}</div>
                        <div style="font-size:0.8rem; color:#666;">${d.votes} Votes</div>
                    </div>
                </div>
            `).join('');
        }

        function renderAccuracy() {
            const list = document.getElementById('accuracyList');
            // Only drawings with score > 0
            const sorted = [...STATE.drawings]
                .filter(d => d.scores.total > 0)
                .sort((a, b) => b.scores.total - a.scores.total)
                .slice(0, 10);

            if(sorted.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">Use a reference photo to get a Smart Score!</div>';
                return;
            }

            list.innerHTML = sorted.map((d, i) => `
                <div class="rank-row">
                    <div class="rank-num rank-${i+1}">${i+1}</div>
                    <img src="${d.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border:1px solid #eee;">
                    <div style="margin-left: 15px; flex: 1;">
                        <div style="font-weight:700;">${escapeHtml(d.artist)}</div>
                        <div style="font-size:0.8rem; color:#666;">
                            Total: <strong>${d.scores.total}%</strong> 
                            (Color: ${d.scores.color}% | Shape: ${d.scores.shape}%)
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILS & HELPERS ---
        function activateTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            // Find button roughly by text content or logic, but for now simple works
            const index = ['draw', 'gallery', 'leaderboard', 'accuracy'].indexOf(tabId);
            if(index >= 0) document.querySelectorAll('.nav-tab')[index].classList.add('active');

            if(tabId === 'gallery') renderGallery();
            if(tabId === 'leaderboard') renderLeaderboard();
            if(tabId === 'accuracy') renderAccuracy();
        }

        function saveData() {
            localStorage.setItem('hddc_drawings', JSON.stringify(STATE.drawings));
            localStorage.setItem('hddc_votes', JSON.stringify([...STATE.myVotes]));
            updateGlobalStats();
        }

        function updateGlobalStats() {
            document.getElementById('statTotalDrawings').textContent = STATE.drawings.length;
            const totalVotes = STATE.drawings.reduce((sum, d) => sum + d.votes, 0);
            document.getElementById('statTotalVotes').textContent = totalVotes;
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast show ${type}`;
            setTimeout(() => t.className = 'toast', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- EVENT BINDINGS (Short) ---
        ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDraw));
        ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, moveDraw));
        ['mouseup', 'touchend'].forEach(evt => window.addEventListener(evt, endDraw));
        
        document.getElementById('btnUndo').onclick = undo;
        document.getElementById('btnClear').onclick = () => { ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); };
        
        // Tool Buttons
        const tools = { btnPen: 'pen', btnBrush: 'brush', btnEraser: 'eraser', btnFill: 'fill' };
        Object.keys(tools).forEach(id => {
            document.getElementById(id).onclick = (e) => {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                STATE.tool = tools[id];
            };
        });

        document.getElementById('colorPicker').onchange = (e) => STATE.color = e.target.value;
        
        document.getElementById('toggleRef').onchange = updateOverlay;
        document.getElementById('opacitySlider').oninput = updateOverlay;

        // START
        init();
	</script>

    	
	    <div id="gallery-container"></div>

		<script>
	let client;

window.addEventListener('load', async function() {
  const SUPABASE_URL = "https://vxfzjzsshwxrqherfmfh.supabase.co";
  const SUPABASE_KEY = "sb_publishable_GOuAPSxNwfuzU1lxVxi4Dw_qN7kY-Xz";

  client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  console.log("Supabase connected! ‚úÖ");

  // Load drawings from Supabase when page loads
  await loadDrawingsFromSupabase();

  // Hook the submit button to save to Supabase
  document.getElementById('btnSubmit').addEventListener('click', publishDrawingToSupabase);
});

async function publishDrawingToSupabase() {
  const titleInput = document.getElementById('dogTitle');
  const artistInput = document.getElementById('artistName');

  const title = titleInput.value.trim();
  const artist = artistInput.value.trim();
  const imageData = canvas.toDataURL();
  const scores = calculateAccuracy();

  if (!title || !artist) {
    alert('Please fill in title and artist name!');
    return;
  }

  try {
    const { data, error } = await client
      .from('drawings')
      .insert([{ 
        title: title, 
        artist_name: artist, 
        image_data: imageData,
        scores: scores,
        votes: 0 
      }]);

    if (error) throw error;

    showToast('Drawing published to Supabase! üéâ', 'success');
    titleInput.value = '';
    artistInput.value = '';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    STATE.history = [];
    STATE.historyStep = -1;

    // Reload gallery
    await loadDrawingsFromSupabase();
    renderGallery();
  } catch (err) {
    console.error('Error publishing:', err);
    showToast('Error saving to Supabase!', 'error');
  }
}

async function loadDrawingsFromSupabase() {
  try {
    const { data, error } = await client
      .from('drawings')
      .select('*')
      .order('votes', { ascending: false });

    if (error) throw error;

    // Convert Supabase data to STATE.drawings format
    STATE.drawings = data.map(d => ({
      id: d.id,
      artist: d.artist_name,
      image: d.image_data,
      votes: d.votes,
       scores: d.scores || { total: 0, color: 0, shape: 0 },
      timestamp: new Date(d.created_at).getTime(),
      isLocal: false
    }));

    console.log('Loaded', STATE.drawings.length, 'drawings from Supabase');
  } catch (err) {
    console.error('Error loading drawings:', err);
    showToast('Could not load drawings', 'error');
  }
}
          </script>
</body>
</html>
