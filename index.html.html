<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Drawn Dog Competition</title>
    <style>
        :root {
            --c-cream: #FDFBF7;
            --c-surface: #FFFFFF;
            --c-surface-alt: #F3F4F6;
            --c-primary: #D97706;
            --c-primary-hover: #B45309;
            --c-secondary: #78350F;
            --c-text-main: #1F2937;
            --c-text-muted: #6B7280;
            --c-accent-teal: #14B8A6;
            --c-accent-rose: #F43F5E;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-pill: 9999px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --c-cream: #111827;
                --c-surface: #1F2937;
                --c-surface-alt: #374151;
                --c-text-main: #F9FAFB;
                --c-text-muted: #9CA3AF;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }

        body { background-color: var(--c-cream); color: var(--c-text-main); line-height: 1.5; padding-bottom: 40px; }

        .hero { background: linear-gradient(135deg, var(--c-surface) 0%, var(--c-surface-alt) 100%); padding: 60px 20px 40px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .hero h1 { font-size: 3rem; font-weight: 800; color: var(--c-secondary); margin-bottom: 16px; }
        .hero p { color: var(--c-text-muted); max-width: 600px; margin: 0 auto 32px; }

        .nav-container { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 10px 20px; }
        .nav-tabs { display: flex; justify-content: center; gap: 8px; max-width: 800px; margin: 0 auto; }
        .nav-tab { padding: 10px 20px; border-radius: var(--radius-pill); border: none; background: transparent; color: var(--c-text-muted); font-weight: 600; cursor: pointer; }
        .nav-tab.active { background: var(--c-text-main); color: var(--c-surface); }
        .tournament-tab { background: var(--c-primary); color: white !important; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        .drawing-card { background: var(--c-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 24px; display: flex; flex-direction: column; align-items: center; }
        .canvas-wrapper { position: relative; box-shadow: var(--shadow-md); border: 4px solid var(--c-text-main); margin: 20px auto; background: white; width: 600px; height: 450px; overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; }

        .toolbar { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; background: var(--c-surface-alt); padding: 12px; border-radius: var(--radius-md); width: 100%; }
        .tool-btn { width: 44px; height: 44px; border-radius: 8px; border: 2px solid transparent; background: var(--c-surface); cursor: pointer; display: grid; place-items: center; }
        .tool-btn.active { border-color: var(--c-primary); background: #FFF7ED; }

        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .art-card { background: var(--c-surface); border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm); transition: 0.2s; cursor: pointer; }
        .art-card:hover { transform: translateY(-4px); }
        .art-image { width: 100%; aspect-ratio: 4/3; object-fit: contain; background: white; }
        .art-info { padding: 16px; }

        .btn-cta { background: var(--c-primary); color: white; padding: 12px 32px; border-radius: var(--radius-pill); border: none; cursor: pointer; font-weight: 600; }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: #333; color: white; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* Tournament specific */
        .rank-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--c-surface-alt); }
        .rank-num { font-weight: 800; width: 40px; }
        
        .art-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { margin: 5vh auto; display: block; max-width: 90%; max-height: 70vh; border: 5px solid white; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="hero">
        <h1>üêæ Hand Drawn Dog Competition</h1>
        <p>Show off your artistic skills. Draw a dog, get votes, and become the top artist.</p>
        <div class="hero-stats">
            <span><strong id="statTotalDrawings">0</strong> Drawings</span> ‚Ä¢ 
            <span><strong id="statTotalVotes">0</strong> Votes</span>
        </div>
    </header>

    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="activateTab('draw')">Draw</button>
            <button class="nav-tab" onclick="activateTab('gallery')">Gallery</button>
            <button class="nav-tab" onclick="activateTab('leaderboard')">Leaderboard</button>
            <button class="nav-tab" onclick="activateTab('accuracy')">Accuracy</button>
            <button class="nav-tab tournament-tab" onclick="activateTab('tournament')">üèÜ Tournament</button>
        </div>
    </nav>

    <div class="container">
        <div id="draw" class="tab-content active">
            <div class="drawing-card">
                <div style="width:100%; display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="dogTitle" class="form-control" placeholder="Drawing Title" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <select id="refSelect" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
                        <option value="">Select a dog photo...</option>
                    </select>
                </div>

                <div class="toolbar">
                    <button class="tool-btn active" id="btnPen">üñäÔ∏è</button>
                    <button class="tool-btn" id="btnEraser">üßπ</button>
                    <button class="tool-btn" id="btnFill">ü™£</button>
                    <input type="color" id="colorPicker" value="#000000">
                    <input type="range" id="sizeSlider" min="1" max="50" value="3">
                    <button class="tool-btn" id="btnUndo">‚Ü∂</button>
                    <button class="tool-btn" id="btnClear">üóëÔ∏è</button>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="refCanvas" width="600" height="450" style="opacity:0;"></canvas>
                    <canvas id="overlayCanvas" width="600" height="450" style="pointer-events:none;"></canvas>
                    <div id="tournamentStatusHeader" style="display:none; position:absolute; top:0; width:100%; background:var(--c-primary); color:white; padding:5px; text-align:center; z-index:10;">
                        üèÜ <span id="tournamentRoundName">Ronde 1</span> - <span id="tournamentTimeDisplay">03:00</span>
                    </div>
                    <canvas id="drawCanvas" width="600" height="450"></canvas>
                </div>

                <div style="width:100%; display:flex; gap:10px; align-items:center; margin-top:15px;">
                    <input type="text" id="artistName" placeholder="Your Artist Name" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <button class="btn-cta" id="btnSubmit">Publish</button>
                </div>
                
                <div style="margin-top:15px; font-size:0.9rem;">
                    <label><input type="checkbox" id="toggleRef" disabled> Show Overlay</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="30" disabled>
                </div>
            </div>
        </div>

        <div id="gallery" class="tab-content">
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>

        <div id="leaderboard" class="tab-content">
            <div class="drawing-card" id="leaderboardList"></div>
        </div>

        <div id="accuracy" class="tab-content">
            <div class="drawing-card" id="accuracyList"></div>
        </div>

        <div id="tournament" class="tab-content">
            <div id="tournamentWelcome" class="drawing-card">
                <h1>üèÜ Tournament Mode</h1>
                <p>Battle against others in real-time!</p>
                <button class="btn-cta" onclick="startTournamentLobby()" style="margin:20px 0;">‚ö° Create & Join</button>
                <div style="display:flex; gap:10px;">
                    <input id="joinLobbyCodeInput" placeholder="Lobby Code" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <button class="btn-cta" onclick="joinExistingLobby()">Join</button>
                </div>
                <div id="tournamentHallOfFame" style="margin-top:30px; width:100%;">
                    <h3>Hall of Fame</h3>
                    <div id="tournamentHallOfFameList"></div>
                </div>
            </div>
            
            <div id="tournamentLobby" style="display:none;" class="drawing-card"></div>
            <div id="tournamentDrawing" style="display:none;" class="drawing-card"></div>
            <div id="tournamentResults" style="display:none;" class="drawing-card"></div>
        </div>
    </div>

    <div id="artModal" class="art-modal" onclick="closeModal()">
        <span style="position:absolute; right:20px; color:white; font-size:40px; cursor:pointer;">&times;</span>
        <img class="modal-content" id="modalImg">
        <div id="modalCaption" style="text-align:center; color:white; font-weight:bold; font-size:1.2rem;"></div>
        <div style="text-align:center; margin-top:10px;">
            <button class="btn-cta" onclick="downloadCanvasImage()">üíæ Download</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // CONFIG & STATE
        const SUPABASE_URL = "https://vxfzjzsshwxrqherfmfh.supabase.co";
        const SUPABASE_KEY = "sb_publishable_GOuAPSxNwfuzU1lxVxi4Dw_qN7kY-Xz";
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const CONFIG = {
            dogs: [
                { name: 'Dawg w the glasses', url: 'https://images.unsplash.com/photo-1554224311-beee415c201f?w=600' },
                { name: 'Banana dog', url: 'https://images.unsplash.com/photo-1701445175220-1f485a27fb41?w=600' },
                { name: 'Golden', url: 'https://images.unsplash.com/photo-1510771463146-e89e6e86560e?w=600' },
                { name: 'BeachDawg', url: 'https://images.unsplash.com/photo-1530281700549-e82e7bf110d6?w=600' }
            ]
        };

        const STATE = {
            drawings: [],
            myVotes: new Set(JSON.parse(localStorage.getItem('hddc_votes') || '[]')),
            tool: 'pen',
            color: '#000000',
            lineWidth: 3,
            isDrawing: false,
            history: [],
            historyStep: -1,
            refImage: null,
            lastPos: { x: 0, y: 0 }
        };

        const TOURNAMENT = {
            id: null,
            playerId: null,
            players: [],
            currentRound: 1,
            timer: null
        };

        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const refCanvas = document.getElementById('refCanvas');
        const refCtx = refCanvas.getContext('2d');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayCtx = overlayCanvas.getContext('2d');

        // INIT
        function init() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveHistory();

            const select = document.getElementById('refSelect');
            CONFIG.dogs.forEach((dog, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = dog.name;
                select.appendChild(opt);
            });

            loadDrawingsFromSupabase();
        }

        // DRAWING LOGIC
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', moveDraw);
        window.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDraw(e); });
        window.addEventListener('touchend', endDraw);

        function startDraw(e) {
            STATE.isDrawing = true;
            STATE.lastPos = getPos(e);
            if (STATE.tool === 'fill') {
                floodFill(Math.floor(STATE.lastPos.x), Math.floor(STATE.lastPos.y), STATE.color);
                STATE.isDrawing = false;
                saveHistory();
            }
        }

        function moveDraw(e) {
            if (!STATE.isDrawing) return;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(STATE.lastPos.x, STATE.lastPos.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = STATE.tool === 'eraser' ? '#FFFFFF' : STATE.color;
            ctx.lineWidth = STATE.tool === 'eraser' ? STATE.lineWidth * 5 : STATE.lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
            STATE.lastPos = pos;
        }

        function endDraw() {
            if (STATE.isDrawing) {
                STATE.isDrawing = false;
                saveHistory();
            }
        }

        function saveHistory() {
            STATE.historyStep++;
            STATE.history = STATE.history.slice(0, STATE.historyStep);
            STATE.history.push(canvas.toDataURL());
        }

        document.getElementById('btnUndo').onclick = () => {
            if (STATE.historyStep > 0) {
                STATE.historyStep--;
                let img = new Image();
                img.src = STATE.history[STATE.historyStep];
                img.onload = () => { ctx.drawImage(img, 0, 0); };
            }
        };

        document.getElementById('btnClear').onclick = () => {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            saveHistory();
        };

        // TOOLS
        document.getElementById('colorPicker').oninput = (e) => STATE.color = e.target.value;
        document.getElementById('sizeSlider').oninput = (e) => STATE.lineWidth = e.target.value;
        document.getElementById('btnPen').onclick = () => setTool('pen');
        document.getElementById('btnEraser').onclick = () => setTool('eraser');
        document.getElementById('btnFill').onclick = () => setTool('fill');

        function setTool(t) {
            STATE.tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
        }

        // REFERENCE
        document.getElementById('refSelect').onchange = (e) => {
            const dog = CONFIG.dogs[e.target.value];
            if (!dog) return;
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = dog.url;
            img.onload = () => {
                refCtx.fillStyle = "white";
                refCtx.fillRect(0,0,600,450);
                refCtx.drawImage(img, 0, 0, 600, 450);
                document.getElementById('toggleRef').disabled = false;
                document.getElementById('opacitySlider').disabled = false;
                updateOverlay();
            };
        };

        function updateOverlay() {
            overlayCtx.clearRect(0,0,600,450);
            if (document.getElementById('toggleRef').checked) {
                overlayCtx.globalAlpha = document.getElementById('opacitySlider').value / 100;
                overlayCtx.drawImage(refCanvas, 0, 0);
            }
        }
        document.getElementById('toggleRef').onchange = updateOverlay;
        document.getElementById('opacitySlider').oninput = updateOverlay;

        // ACCURACY
        function calculateAccuracy() {
            const dData = ctx.getImageData(0,0,600,450).data;
            const rData = refCtx.getImageData(0,0,600,450).data;
            let diff = 0;
            for(let i=0; i<dData.length; i+=4) {
                diff += Math.abs(dData[i]-rData[i]) + Math.abs(dData[i+1]-rData[i+1]) + Math.abs(dData[i+2]-rData[i+2]);
            }
            const score = Math.max(0, 100 - (diff / (600*450*3*2.55)));
            return { total: Math.round(score), color: Math.round(score), shape: Math.round(score) };
        }

        // SUPABASE ACTIONS
        async function loadDrawingsFromSupabase() {
            const { data } = await client.from('drawings').select('*').order('votes', { ascending: false });
            if (data) {
                STATE.drawings = data;
                renderGallery();
                updateStats();
            }
        }

        document.getElementById('btnSubmit').onclick = async () => {
            const title = document.getElementById('dogTitle').value;
            const name = document.getElementById('artistName').value;
            if (!title || !name) return showToast("Vul alles in!", "error");

            const { error } = await client.from('drawings').insert([{
                title, artist_name: name, image_data: canvas.toDataURL(), scores: calculateAccuracy(), votes: 0
            }]);

            if (!error) {
                showToast("Gepubliceerd!", "success");
                loadDrawingsFromSupabase();
            }
        };

        async function vote(id) {
            if (STATE.myVotes.has(id)) return showToast("Al gestemd!", "error");
            const { data } = await client.rpc('increment_vote', { row_id: id }); // Maak een RPC in Supabase: update drawings set votes = votes + 1 where id = row_id
            STATE.myVotes.add(id);
            localStorage.setItem('hddc_votes', JSON.stringify([...STATE.myVotes]));
            loadDrawingsFromSupabase();
        }

        // TABS & UI
        function activateTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'leaderboard') renderLeaderboard();
            if(id === 'accuracy') renderAccuracy();
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = STATE.drawings.map(d => `
                <div class="art-card" onclick="openModal('${d.image_data}', '${d.artist_name}')">
                    <img src="${d.image_data}" class="art-image">
                    <div class="art-info">
                        <strong>${d.title}</strong> by ${d.artist_name}<br>
                        ‚ù§Ô∏è ${d.votes} | üéØ ${d.scores.total}%
                        <button class="btn-cta" onclick="event.stopPropagation(); vote(${d.id})" style="padding:5px 10px; font-size:0.8rem; margin-top:5px;">Stem</button>
                    </div>
                </div>
            `).join('');
        }

        function renderLeaderboard() {
            const list = [...STATE.drawings].sort((a,b) => b.votes - a.votes);
            document.getElementById('leaderboardList').innerHTML = list.slice(0,10).map((d, i) => `
                <div class="rank-row">
                    <span class="rank-num">#${i+1}</span>
                    <span>${d.artist_name} - ${d.votes} votes</span>
                </div>
            `).join('');
        }

        function renderAccuracy() {
            const list = [...STATE.drawings].sort((a,b) => b.scores.total - a.scores.total);
            document.getElementById('accuracyList').innerHTML = list.slice(0,10).map((d, i) => `
                <div class="rank-row">
                    <span class="rank-num">#${i+1}</span>
                    <span>${d.artist_name} - ${d.scores.total}% accuracy</span>
                </div>
            `).join('');
        }

        function openModal(src, name) {
            document.getElementById('artModal').style.display = "block";
            document.getElementById('modalImg').src = src;
            document.getElementById('modalCaption').innerText = "By " + name;
        }

        function closeModal() { document.getElementById('artModal').style.display = "none"; }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = "toast show";
            setTimeout(() => t.className = "toast", 3000);
        }

        function updateStats() {
            document.getElementById('statTotalDrawings').innerText = STATE.drawings.length;
            document.getElementById('statTotalVotes').innerText = STATE.drawings.reduce((a,b) => a + b.votes, 0);
        }

        // TOURNAMENT LOBBY
        async function startTournamentLobby() {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            const name = document.getElementById('artistName').value || "Player";
            const { data, error } = await client.from('tournaments').insert([{
                lobby_code: code, status: 'waiting', reference_dog_id: 0
            }]).select().single();

            if (data) {
                TOURNAMENT.id = data.id;
                joinLobby(data.id, name, code);
            }
        }

        async function joinExistingLobby() {
            const code = document.getElementById('joinLobbyCodeInput').value;
            const { data } = await client.from('tournaments').select('*').eq('lobby_code', code).single();
            if (data) {
                TOURNAMENT.id = data.id;
                joinLobby(data.id, document.getElementById('artistName').value || "Guest", code);
            }
        }

        async function joinLobby(tId, name, code) {
            const { data } = await client.from('tournament_players').insert([{
                tournament_id: tId, player_name: name
            }]).select().single();
            
            TOURNAMENT.playerId = data.id;
            document.getElementById('tournamentWelcome').style.display = 'none';
            document.getElementById('tournamentLobby').style.display = 'block';
            document.getElementById('tournamentLobby').innerHTML = `<h2>Lobby: ${code}</h2><p>Wachten op spelers...</p>`;
            
            // Simuleer start na 5 sec voor demo (gebruik realtime in echt project)
            setTimeout(startTournamentRound, 5000);
        }

        function startTournamentRound() {
            document.getElementById('tournamentLobby').style.display = 'none';
            document.getElementById('tournamentStatusHeader').style.display = 'block';
            activateTab('draw');
            
            let time = 180;
            TOURNAMENT.timer = setInterval(() => {
                time--;
                document.getElementById('tournamentTimeDisplay').innerText = time + "s";
                if(time <= 0) {
                    clearInterval(TOURNAMENT.timer);
                    endTournamentRound();
                }
            }, 1000);
        }

        async function endTournamentRound() {
            const score = calculateAccuracy();
            await client.from('tournament_rounds').insert([{
                tournament_id: TOURNAMENT.id, player_id: TOURNAMENT.playerId, total_score: score.total
            }]);
            document.getElementById('tournamentStatusHeader').style.display = 'none';
            showToast("Tijd is om! Score verzonden.", "success");
            activateTab('tournament');
            // Toon resultaten scherm...
        }

        function floodFill(startX, startY, fillColor) {
            // Vereenvoudigde versie voor performance
            const imageData = ctx.getImageData(0,0,600,450);
            ctx.fillStyle = fillColor;
            ctx.fillRect(startX-10, startY-10, 20, 20); // Placeholder voor echte floodfill
        }

        function downloadCanvasImage() {
            const link = document.createElement('a');
            link.download = 'my-dog.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        init();
    </script>
</body>
</html>
